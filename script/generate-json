#!/usr/bin/env ruby

require 'json'
require 'csv'
require 'pp'

# Translate old teams to their modern representation
TEAMS = {
  NOK: 'OKC',
  SEA: 'OKC',
  NOJ: 'UTA',
  BAL: 'WAS',
  CHP: 'WAS',
  CHZ: 'WAS',
  WSB: 'WAS',
  CAP: 'WAS',
  BUF: 'LAC',
  SDC: 'LAC',
  MLH: 'ATL',
  STL: 'ATL',
  TRI: 'ATL',
  VAN: 'MEM',
  ROC: 'SAC',
  KCK: 'SAC',
  KCO: 'SAC',
  CIN: 'SAC',
  SDR: 'HOU',
  CHO: 'CHA',
  CHH: 'CHA',
  PHW: 'GSW',
  SFW: 'GSW',
  SYR: 'PHI',
  MNL: 'LAL',
  FTW: 'DET',
  NYN: 'BKN',
  NJN: 'BKN',
  BRK: 'BKN',
  NOH: 'NOP',
  PHO: 'PHX'
}

# Teams that are no longer around
DEFUNCT = ['SHE', 'WAT', 'STB', 'WSC', 'AND', 'DNN', 'CHS', 'BLB', 'INO']

rows = CSV.read("coaches.csv", headers: true, header_converters: :symbol)
rows.each do |r|
  abbr = r[:team].to_sym
  r[:team] = TEAMS.has_key?(abbr) ? TEAMS[abbr] : abbr.to_s
end

rows = rows.select { |t| !DEFUNCT.include?(t[:team]) }
rows.each do |row|
  row[:start] = row[:season].split('-').first.to_i
  row[:finish] = row[:start] + 1
end

# teams = rows.select { |r| r[:team] == 'POR' }
teams = rows.group_by {|r| r[:team] }

# Group coaches by tenures
teams = teams.map do |name, coaches|
  tenures = {}
  coaches.sort_by! {|c| c[:start] }
  seasons = coaches.map { |c| c[:season] }.uniq
  seasons.each do |season|
    tenures[season] = coaches.select { |c| c[:season] == season }.map(&:to_h)
  end

  [name, tenures]
end


puts JSON.pretty_generate(teams)
